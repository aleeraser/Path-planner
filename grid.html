<html>

<head>
    <title>Canvas Grid</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="css/materialize.css" media="screen,projection" />
    <link rel="stylesheet" type="text/css" href="css/general.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />

</head>

<body class="dark-theme">
    <canvas id="canvas"></canvas>
    <div class="draggable card blue-grey lighten-5">
        <div class="card-content">

            <div class="row">
                <ul class="collapsible">
                    <li>
                        <div class="collapsible-header blue-grey lighten-4 blue-grey-text">
                            <div class="valign-wrapper">
                                <i class="material-icons " id="collapsible-icon">chevron_right</i>
                                <h5>Instructions</h5>
                            </div>
                        </div>
                        <div class="collapsible-body white">
                            <p>Use the left mouse button to place or remove obstacles.
                                <span style="font-weight: bold">Tip</span>: you can also click and drag!</p>
                            <p>Use the right mouse button to place
                                <span class="green-text darken-1">start</span> and
                                <span class="red-text darken-1">end</span> points. The path calculation will immediately start after placing the
                                <span class="red-text darken-1">end</span> point.</p>
                            <p>Path will be calculated using a planning algorithm picked from the selection below.</p>
                        </div>
                    </li>
                </ul>

                <br>

                <div class="input-field col s12">
                    <select id="methodSelect">
                        <option value="decomposition" selected>Cellular Decomposition</option>
                        <option value="visibility">Visibility Graph</option>
                        <option value="probabilistic">Probabilistic Roadmap</option>
                        <option value="bug1">Bug v1</option>
                        <option value="bug2">Bug v2</option>
                        <option value="tangent-bug">Tangent Bug</option>
                    </select>
                    <label>Planning algorithm</label>
                </div>

                <br>

                <div class="input-field col s12">
                    <p id="theme-header" class="label">Theme</p>
                    <p>
                        <label>
                            <input type="radio" class="with-gap" name="theme" value="dark" onclick="updateTheme(this);" checked />
                            <span class="theme-option">Dark</span>
                        </label>
                    </p>
                    <p>
                        <label>
                            <input type="radio" class="with-gap" name="theme" value="light" onclick="updateTheme(this);" />
                            <span class="theme-option">Light</span>
                        </label>
                    </p>
                </div>

            </div>
            <div class="card-action center-align">
                <button class="btn blue-grey white-text" onclick="clearWalls()">Clear walls</button>
                <button class="btn blue-grey white-text" onclick="grid.clearPaths()">Clear path</button>
            </div>

        </div>

        <script type="text/javascript" src="js/grid.js"></script>
        <script type="text/javascript" src="libs/graph.js"></script>
        <script type="text/javascript" src="libs/materialize.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
        <script>
            var grid;
            var width = document.body.clientWidth,
                height = document.body.clientHeight;

            function clearWalls() {
                grid.clearWalls();
            }

            function clearPaths() {
                grid.clearPaths();
            }

            // Create class passing canvas object id
            grid = new Grid('canvas', width, height);

            // Apply settings and generate grid on canvas
            grid.generate();

            // Click listener
            grid.setOnCellClickDrag(function (x, y) {
                grid.toggleWall(x, y);
            });

            grid.setOnCellRightClick(function (cell) {
                grid.relocateStartEnd(cell);
            });

            var select = document.getElementById("methodSelect");
            grid.setAlgorithm(select.value);
            select.onchange = function () {
                grid.setAlgorithm(this.value);
                grid.evaluatePath();
            };

            // material select init
            document.addEventListener('DOMContentLoaded', function () {
                var elems = document.querySelectorAll('select');
                var instances = M.FormSelect.init(elems);
            });

            // collapsible init
            document.addEventListener('DOMContentLoaded', function () {
                var elems = document.querySelectorAll('.collapsible');
                var instances = M.Collapsible.init(elems, {
                    onOpenStart: function () {
                        document.getElementById("collapsible-icon").innerHTML = "arrow_drop_down";
                    },
                    onCloseStart: function () {
                        document.getElementById("collapsible-icon").innerHTML = "chevron_right";
                    }
                });
            });

            // theme selection
            var currentTheme = "dark";

            function updateTheme(myRadio) {

                currentTheme = myRadio.value;

                if (currentTheme == "light") {
                    $("body").removeClass("dark-theme").addClass("light-theme");
                    $(".card").removeClass("lighten-5").addClass("darken-3");
                    $(".collapsible-header").removeClass("lighten-4").addClass("text-lighten-4");
                    $(".collapsible-body").removeClass("white").addClass("blue-grey").addClass("darken-1").addClass(
                        "blue-grey-text").addClass("text-lighten-4");
                    $("#theme-header").addClass("blue-grey-text").addClass("text-lighten-2");
                    $(".theme-option").addClass("blue-grey-text").addClass("text-lighten-4");
                    grid.lightTheme(true);
                } else if (currentTheme == "dark") {
                    $("body").removeClass("light-theme").addClass("dark-theme");
                    $(".card").removeClass("darken-3").addClass("lighten-5");
                    $(".collapsible-header").removeClass("text-lighten-4").addClass("lighten-4");
                    $(".collapsible-body").removeClass("blue-grey").removeClass("darken-1").removeClass(
                        "blue-grey-text").removeClass("text-lighten-4").addClass("white");
                    $("#theme-header").removeClass("blue-grey-text").removeClass("text-lighten-2");
                    $(".theme-option").removeClass("blue-grey-text").removeClass("text-lighten-4");
                    grid.darkTheme(true);
                }
            }


            // instructions panel drag
            var instructionsPanel = $('.draggable'); //element 

            instructionsPanel.on('mousedown', function (e) {
                var dr = $(this).addClass("drag").css("cursor", "move");
                height = dr.outerHeight();
                width = dr.outerWidth();
                max_left = dr.parent().offset().left + dr.parent().width() - dr.width();
                max_top = dr.parent().offset().top + dr.parent().height() - dr.height();
                min_left = dr.parent().offset().left;
                min_top = dr.parent().offset().top;

                ypos = dr.offset().top + height - e.pageY,
                    xpos = dr.offset().left + width - e.pageX;
                $(document.body).on('mousemove', function (e) {
                    var itop = e.pageY + ypos - height;
                    var ileft = e.pageX + xpos - width;

                    if (dr.hasClass("drag")) {
                        if (itop <= min_top) {
                            itop = min_top;
                        }
                        if (ileft <= min_left) {
                            ileft = min_left;
                        }
                        if (itop >= max_top) {
                            itop = max_top;
                        }
                        if (ileft >= max_left) {
                            ileft = max_left;
                        }
                        dr.offset({
                            top: itop,
                            left: ileft
                        });
                    }
                }).on('mouseup', function (e) {
                    dr.removeClass("drag");
                });
            });
        </script>
</body>

</html>